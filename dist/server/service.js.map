{"version":3,"sources":["../service.ts"],"names":[],"mappings":";;;;;;;AAAA,+BAAiC;AAGjC,uBAAyB;AAEzB,IAAI,aAAa,GAAG,0BAA0B,CAAC;AAG/C,IAAa,OAAO;IAEhB,iBAAoB,IAAa,EAAU,QAAkB;QAAzC,SAAI,GAAJ,IAAI,CAAS;QAAU,aAAQ,GAAR,QAAQ,CAAU;IAG7D,CAAC;IAEO,8BAAY,GAApB,UAAqB,MAAc;QAE/B,IAAI,KAAK,GAAG,IAAI,EAAE,CAAC,QAAQ,EAAO,CAAC;QACnC,IAAI,SAAS,GAAG,UAAU,IAAI;YAE1B,EAAE,CAAC,MAAM,CAAC,aAAa,EAAE,UAAU,MAAM;gBAErC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC;oBACR,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;gBAChC,EAAE,CAAC,SAAS,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,UAAU,GAAG;oBAEtD,EAAE,CAAC,CAAC,GAAG,CAAC;wBACJ,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;oBACtB,IAAI;wBACA,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;gBAC5B,CAAC,CAAC,CAAC;YACP,CAAC,CAAC,CAAA;QACN,CAAC,CAAC;QACF,IAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;QACzC,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CACd,CAAC;YACG,YAAY,CAAC;gBAET,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;gBAChC,KAAK,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAA;YACpC,CAAC,CAAC,CAAC;YACH,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC;QACD,IAAI,QAAQ,GAAG,aAAa,GAAG,MAAM,GAAG,GAAG,GAAG,QAAQ,CAAC,QAAQ,GAAG,GAAG,GAAG,QAAQ,CAAC,SAAS,GAAG,OAAO,CAAC;QACrG,IAAI,GAAG,GAAG,6DAA6D,GAAG,MAAM,GAAG,aAAa,GAAG,QAAQ,CAAC,QAAQ,GAAG,GAAG,GAAG,QAAQ,CAAC,SAAS,GAAG,OAAO,CAAC;QAC1J,IAAI,IAAI,GAAG,IAAI,CAAC;QAChB,EAAE,CAAC,MAAM,CAAC,QAAQ,EAAE,UAAU,MAAM;YAEhC,EAAE,CAAC,CAAC,MAAM,CAAC,CACX,CAAC;gBACG,EAAE,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,GAAG,EAAE,KAAK;oBAElC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;oBACzB,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,GAAG,KAAK,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC,CAChE,CAAC;wBACG,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,UAAU,GAAG,EAAE,IAAI;4BAErC,EAAE,CAAC,CAAC,GAAG,CAAC;gCACJ,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,KAAK;oCAElD,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gCACxB,CAAC,CAAC,CAAC;4BACP,IACA,CAAC;gCACG,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;4BAC/C,CAAC;4BACD,KAAK,CAAC,CAAC,CAAC,CAAC,CACT,CAAC;gCACG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,KAAK;oCAElD,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gCACxB,CAAC,CAAC,CAAA;4BACN,CAAC;wBACL,CAAC,CAAC,CAAA;oBACN,CAAC;oBACD,IAAI;wBACA,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,KAAK;4BAElD,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;wBACxB,CAAC,CAAC,CAAA;gBAEV,CAAC,CAAC,CAAA;YACN,CAAC;YACD,IAAI;gBACA,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,KAAK;oBAElD,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBACxB,CAAC,CAAC,CAAA;QAEV,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,KAAK,CAAC;IACjB,CAAC;IAGM,yBAAO,GAAd;QAEI,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;IAC3C,CAAC;IAAA,CAAC;IAEK,0BAAQ,GAAf;QAEI,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;IACzC,CAAC;IAAA,CAAC;IACN,cAAC;AAAD,CAhGA,AAgGC,IAAA;AAhGY,OAAO;IADnB,EAAE,CAAC,OAAO,CAAC,SAAS,EAAE,OAAO,EAAE,UAAU,CAAC;GAC9B,OAAO,CAgGnB;AAhGY,0BAAO","file":"service.js","sourcesContent":["import * as di from 'akala-core';\r\nimport * as express from 'express';\r\nimport { Settings } from '../../../settings';\r\nimport * as fs from 'fs';\r\n\r\nvar baseCachePath = './modules/weather/cache/';\r\n\r\n@di.service('weather', '$http', 'settings')\r\nexport class Weather\r\n{\r\n    constructor(private http: di.Http, private settings: Settings)\r\n    {\r\n\r\n    }\r\n\r\n    private getFromCache(method: string): PromiseLike<any>\r\n    {\r\n        var defer = new di.Deferred<any>();\r\n        var cacheData = function (data)\r\n        {\r\n            fs.exists(baseCachePath, function (exists)\r\n            {\r\n                if (!exists)\r\n                    fs.mkdirSync(baseCachePath);\r\n                fs.writeFile(fileName, JSON.stringify(data), function (err)\r\n                {\r\n                    if (err)\r\n                        defer.reject(err);\r\n                    else\r\n                        defer.resolve(data);\r\n                });\r\n            })\r\n        };\r\n        var position = this.settings('position');\r\n        if (!position)\r\n        {\r\n            setImmediate(function ()\r\n            {\r\n                console.log('invalid position');\r\n                defer.reject('invalid position')\r\n            });\r\n            return defer;\r\n        }\r\n        var fileName = baseCachePath + method + '-' + position.latitude + ',' + position.longitude + '.json';\r\n        var url = 'http://api.wunderground.com/api/eff76d6447a195e1/geolookup/' + method + '/lang:FR/q/' + position.latitude + ',' + position.longitude + '.json';\r\n        var self = this;\r\n        fs.exists(fileName, function (exists)\r\n        {\r\n            if (exists)\r\n            {\r\n                fs.stat(fileName, function (err, stats)\r\n                {\r\n                    console.log(stats.mtime);\r\n                    if ((new Date().valueOf() - stats.mtime.valueOf()) / 60000 < 15)\r\n                    {\r\n                        fs.readFile(fileName, function (err, data)\r\n                        {\r\n                            if (err)\r\n                                self.http.getJSON(url).then(cacheData, function (error)\r\n                                {\r\n                                    defer.reject(error);\r\n                                });\r\n                            try\r\n                            {\r\n                                defer.resolve(JSON.parse(data.toString()));\r\n                            }\r\n                            catch (e)\r\n                            {\r\n                                self.http.getJSON(url).then(cacheData, function (error)\r\n                                {\r\n                                    defer.reject(error);\r\n                                })\r\n                            }\r\n                        })\r\n                    }\r\n                    else\r\n                        self.http.getJSON(url).then(cacheData, function (error)\r\n                        {\r\n                            defer.reject(error);\r\n                        })\r\n\r\n                })\r\n            }\r\n            else\r\n                self.http.getJSON(url).then(cacheData, function (error)\r\n                {\r\n                    defer.reject(error);\r\n                })\r\n\r\n        });\r\n\r\n        return defer;\r\n    }\r\n\r\n\r\n    public getInfo()\r\n    {\r\n        return this.getFromCache('conditions');\r\n    };\r\n\r\n    public forecast()\r\n    {\r\n        return this.getFromCache('forecast');\r\n    };\r\n}"],"sourceRoot":"weather/src/server"}